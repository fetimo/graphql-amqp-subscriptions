"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _pubsub = require("./pubsub");

var _chai = require("chai");

require("mocha");

var _amqplib = _interopRequireDefault(require("amqplib"));

/* tslint:disable:no-unused-expression */
var conn;
var pubsub;
describe('AMQP PubSub', function () {
  before(function (done) {
    _amqplib.default.connect('amqp://guest:guest@localhost:5672?heartbeat=30').then(function (amqpConn) {
      conn = amqpConn;
      done();
    }).catch(function (err) {
      done(err);
    });
  });
  after(function (done) {
    conn.close().then(function () {
      done();
    }).catch(function (err) {
      done(err);
    });
  });
  it('should create new instance of AMQPPubSub class', function () {
    pubsub = new _pubsub.AMQPPubSub({
      connection: conn
    });
    (0, _chai.expect)(pubsub).to.exist;
  });
  it('should be able to receive a message with the appropriate routingKey', function (done) {
    pubsub.subscribe('testx.*', function (message) {
      (0, _chai.expect)(message).to.exist;
      (0, _chai.expect)(message.test).to.equal('data');
      done();
    }).then(function (subscriberId) {
      (0, _chai.expect)(subscriberId).to.exist;
      pubsub.publish('testx.test', {
        test: 'data'
      }).then(function () {
        (0, _chai.expect)(true).to.equal(true);
      }).catch(function (err) {
        (0, _chai.expect)(err).to.not.exist;
        done();
      });
    }).catch(function (err) {
      (0, _chai.expect)(err).to.not.exist;
      done();
    });
  });
  it('should be able to unsubscribe', function (done) {
    pubsub.subscribe('test.test', function () {
      done(new Error('Should not reach'));
    }).then(function (subscriberId) {
      (0, _chai.expect)(subscriberId).to.exist;
      (0, _chai.expect)(isNaN(subscriberId)).to.equal(false);
      pubsub.unsubscribe(subscriberId).then(function () {
        done();
      }).catch(function (err) {
        (0, _chai.expect)(err).to.not.exist;
      });
    }).catch(function (err) {
      (0, _chai.expect)(err).to.not.exist;
      done();
    });
  });
  it('should be able to receive a message after one of two subscribers unsubscribed', function (done) {
    // Subscribe two
    pubsub.subscribe('testy.test', function () {
      done(new Error('Should not reach'));
    }).then(function (id1) {
      pubsub.subscribe('testy.test', function (message) {
        // Receive message
        (0, _chai.expect)(message).to.exist;
        (0, _chai.expect)(message.test).to.equal('data');
        done();
      }).then(function (id2) {
        (0, _chai.expect)(id1).to.exist;
        (0, _chai.expect)(id2).to.exist;
        (0, _chai.expect)(id1).to.not.equal(id2); // Unsubscribe one

        pubsub.unsubscribe(id1).then(function () {
          pubsub.publish('testy.test', {
            test: 'data'
          }).then(function () {
            (0, _chai.expect)(true).to.equal(true);
          }).catch(function (err) {
            (0, _chai.expect)(err).to.not.exist;
            done();
          });
        }).catch(function (err) {
          (0, _chai.expect)(err).to.not.exist;
        });
      }).catch(function (err) {
        (0, _chai.expect)(err).to.not.exist;
      });
    }).catch(function (err) {
      (0, _chai.expect)(err).to.not.exist;
      done();
    });
  });
  it('should be able to receive a message after one of two subscribers unsubscribed (concurrent)', function (done) {
    // Subscribe two
    Promise.all([pubsub.subscribe('testz.test', function () {
      done(new Error('Should not reach'));
    }), pubsub.subscribe('testz.test', function (message) {
      // Receive message
      (0, _chai.expect)(message).to.exist;
      (0, _chai.expect)(message.test).to.equal('data');
      done();
    })]).then(function (_ref) {
      var _ref2 = (0, _slicedToArray2.default)(_ref, 2),
          id1 = _ref2[0],
          id2 = _ref2[1];

      (0, _chai.expect)(id1).to.exist;
      (0, _chai.expect)(id2).to.exist;
      (0, _chai.expect)(id1).to.not.equal(id2); // Unsubscribe one

      pubsub.unsubscribe(id1).then(function () {
        pubsub.publish('testz.test', {
          test: 'data'
        }).then(function () {
          (0, _chai.expect)(true).to.equal(true);
        }).catch(function (err) {
          (0, _chai.expect)(err).to.not.exist;
          done();
        });
      }).catch(function (err) {
        (0, _chai.expect)(err).to.not.exist;
      });
    }).catch(function (err) {
      (0, _chai.expect)(err).to.not.exist;
      done();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wdWJzdWIudGVzdC50cyJdLCJuYW1lcyI6WyJjb25uIiwicHVic3ViIiwiZGVzY3JpYmUiLCJiZWZvcmUiLCJkb25lIiwiYW1xcCIsImNvbm5lY3QiLCJ0aGVuIiwiYW1xcENvbm4iLCJjYXRjaCIsImVyciIsImFmdGVyIiwiY2xvc2UiLCJpdCIsIkFNUVBQdWJTdWIiLCJjb25uZWN0aW9uIiwidG8iLCJleGlzdCIsInN1YnNjcmliZSIsIm1lc3NhZ2UiLCJ0ZXN0IiwiZXF1YWwiLCJzdWJzY3JpYmVySWQiLCJwdWJsaXNoIiwibm90IiwiRXJyb3IiLCJpc05hTiIsInVuc3Vic2NyaWJlIiwiaWQxIiwiaWQyIiwiUHJvbWlzZSIsImFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSkE7QUFNQSxJQUFJQSxJQUFKO0FBQ0EsSUFBSUMsTUFBSjtBQUVBQyxRQUFRLENBQUMsYUFBRCxFQUFnQixZQUFNO0FBRTVCQyxFQUFBQSxNQUFNLENBQUMsVUFBQ0MsSUFBRCxFQUFVO0FBQ2ZDLHFCQUFLQyxPQUFMLENBQWEsZ0RBQWIsRUFDQ0MsSUFERCxDQUNNLFVBQUFDLFFBQVEsRUFBSTtBQUNoQlIsTUFBQUEsSUFBSSxHQUFHUSxRQUFQO0FBQ0FKLE1BQUFBLElBQUk7QUFDTCxLQUpELEVBS0NLLEtBTEQsQ0FLTyxVQUFBQyxHQUFHLEVBQUk7QUFDWk4sTUFBQUEsSUFBSSxDQUFDTSxHQUFELENBQUo7QUFDRCxLQVBEO0FBUUQsR0FUSyxDQUFOO0FBV0FDLEVBQUFBLEtBQUssQ0FBQyxVQUFDUCxJQUFELEVBQVU7QUFDZEosSUFBQUEsSUFBSSxDQUFDWSxLQUFMLEdBQ0NMLElBREQsQ0FDTSxZQUFNO0FBQ1ZILE1BQUFBLElBQUk7QUFDTCxLQUhELEVBSUNLLEtBSkQsQ0FJTyxVQUFBQyxHQUFHLEVBQUk7QUFDWk4sTUFBQUEsSUFBSSxDQUFDTSxHQUFELENBQUo7QUFDRCxLQU5EO0FBT0QsR0FSSSxDQUFMO0FB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QjtBQUFDSCxVQUFBQSxJQUFJLEVBQUU7QUFBUCxTQUE3QixFQUNDYixJQURELENBQ00sWUFBTTtBQUNWLDRCQUFPLElBQVAsRUFBYVMsRUFBYixDQUFnQkssS0FBaEIsQ0FBc0IsSUFBdEI7QUFDRCxTQUhELEVBSUNaLEtBSkQsQ0FJTyxVQUFBQyxHQUFHLEVBQUk7QUFDWiw0QkFBT0EsR0FBUCxFQUFZTSxFQUFaLENBQWVRLEdBQWYsQ0FBbUJQLEtBQW5CO0FBQ0FiLFVBQUFBLElBQUk7QUFDTCxTQVBEO0FBUUQsT0FWRCxFQVdDSyxLQVhELENBV08sVUFBQUMsR0FBRyxFQUFJO0FBQ1osMEJBQU9BLEdBQVAsRUFBWU0sRUFBWixDQUFlUSxHQUFmLENBQW1CUCxLQUFuQjtBQUNELE9BYkQ7QUFjRCxLQTlCRCxFQStCQ1IsS0EvQkQsQ0ErQk8sVUFBQUMsR0FBRyxFQUFJO0FBQ1osd0JBQU9BLEdBQVAsRUFBWU0sRUFBWixDQUFlUSxHQUFmLENBQW1CUCxLQUFuQjtBQUNBYixNQUFBQSxJQUFJO0FBQ0wsS0FsQ0Q7QUFtQ0QsR0FyQ0MsQ0FBRjtBQXVDRCxDQXpKTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6bm8tdW51c2VkLWV4cHJlc3Npb24gKi9cbmltcG9ydCB7IEFNUVBQdWJTdWIgfSBmcm9tICcuL3B1YnN1Yic7XG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJztcbmltcG9ydCAnbW9jaGEnO1xuaW1wb3J0IGFtcXAgZnJvbSAnYW1xcGxpYic7XG5cbmxldCBjb25uOiBhbXFwLkNvbm5lY3Rpb247XG5sZXQgcHVic3ViOiBBTVFQUHViU3ViO1xuXG5kZXNjcmliZSgnQU1RUCBQdWJTdWInLCAoKSA9PiB7XG5cbiAgYmVmb3JlKChkb25lKSA9PiB7XG4gICAgYW1xcC5jb25uZWN0KCdhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAbG9jYWxob3N0OjU2NzI/aGVhcnRiZWF0PTMwJylcbiAgICAudGhlbihhbXFwQ29ubiA9PiB7XG4gICAgICBjb25uID0gYW1xcENvbm47XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGRvbmUoZXJyKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgYWZ0ZXIoKGRvbmUpID0+IHtcbiAgICBjb25uLmNsb3NlKClcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICBkb25lKCk7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGRvbmUoZXJyKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjcmVhdGUgbmV3IGluc3RhbmNlIG9mIEFNUVBQdWJTdWIgY2xhc3MnLCAoKSA9PiB7XG4gICAgcHVic3ViID0gbmV3IEFNUVBQdWJTdWIoeyBjb25uZWN0aW9uOiBjb25uIH0pO1xuICAgIGV4cGVjdChwdWJzdWIpLnRvLmV4aXN0O1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gcmVjZWl2ZSBhIG1lc3NhZ2Ugd2l0aCB0aGUgYXBwcm9wcmlhdGUgcm91dGluZ0tleScsIChkb25lKSA9PiB7XG4gICAgcHVic3ViLnN1YnNjcmliZSgndGVzdHguKicsIChtZXNzYWdlKSA9PiB7XG4gICAgICBleHBlY3QobWVzc2FnZSkudG8uZXhpc3Q7XG4gICAgICBleHBlY3QobWVzc2FnZS50ZXN0KS50by5lcXVhbCgnZGF0YScpO1xuICAgICAgZG9uZSgpO1xuICAgIH0pXG4gICAgLnRoZW4oc3Vic2NyaWJlcklkID0+IHtcbiAgICAgIGV4cGVjdChzdWJzY3JpYmVySWQpLnRvLmV4aXN0O1xuICAgICAgcHVic3ViLnB1Ymxpc2goJ3Rlc3R4LnRlc3QnLCB7dGVzdDogJ2RhdGEnfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRydWUpLnRvLmVxdWFsKHRydWUpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5ub3QuZXhpc3Q7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pO1xuICAgIH0pXG4gICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICBleHBlY3QoZXJyKS50by5ub3QuZXhpc3Q7XG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYmUgYWJsZSB0byB1bnN1YnNjcmliZScsIChkb25lKSA9PiB7XG4gICAgcHVic3ViLnN1YnNjcmliZSgndGVzdC50ZXN0JywgKCkgPT4ge1xuICAgICAgZG9uZShuZXcgRXJyb3IoJ1Nob3VsZCBub3QgcmVhY2gnKSk7XG4gICAgfSlcbiAgICAudGhlbihzdWJzY3JpYmVySWQgPT4ge1xuICAgICAgZXhwZWN0KHN1YnNjcmliZXJJZCkudG8uZXhpc3Q7XG4gICAgICBleHBlY3QoaXNOYU4oc3Vic2NyaWJlcklkKSkudG8uZXF1YWwoZmFsc2UpO1xuICAgICAgcHVic3ViLnVuc3Vic2NyaWJlKHN1YnNjcmliZXJJZClcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICBleHBlY3QoZXJyKS50by5ub3QuZXhpc3Q7XG4gICAgICB9KTtcbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgZXhwZWN0KGVycikudG8ubm90LmV4aXN0O1xuICAgICAgZG9uZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gcmVjZWl2ZSBhIG1lc3NhZ2UgYWZ0ZXIgb25lIG9mIHR3byBzdWJzY3JpYmVycyB1bnN1YnNjcmliZWQnLCAoZG9uZSkgPT4ge1xuICAgIC8vIFN1YnNjcmliZSB0d29cbiAgICBwdWJzdWIuc3Vic2NyaWJlKCd0ZXN0eS50ZXN0JywgKCkgPT4ge1xuICAgICAgZG9uZShuZXcgRXJyb3IoJ1Nob3VsZCBub3QgcmVhY2gnKSk7XG4gICAgfSlcbiAgICAudGhlbihpZDEgPT4ge1xuICAgICAgcHVic3ViLnN1YnNjcmliZSgndGVzdHkudGVzdCcsIChtZXNzYWdlKSA9PiB7XG4gICAgICAgIC8vIFJlY2VpdmUgbWVzc2FnZVxuICAgICAgICBleHBlY3QobWVzc2FnZSkudG8uZXhpc3Q7XG4gICAgICAgIGV4cGVjdChtZXNzYWdlLnRlc3QpLnRvLmVxdWFsKCdkYXRhJyk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihpZDIgPT4ge1xuICAgICAgICBleHBlY3QoaWQxKS50by5leGlzdDtcbiAgICAgICAgZXhwZWN0KGlkMikudG8uZXhpc3Q7XG4gICAgICAgIGV4cGVjdChpZDEpLnRvLm5vdC5lcXVhbChpZDIpO1xuICAgICAgICAvLyBVbnN1YnNjcmliZSBvbmVcbiAgICAgICAgcHVic3ViLnVuc3Vic2NyaWJlKGlkMSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHB1YnN1Yi5wdWJsaXNoKCd0ZXN0eS50ZXN0Jywge3Rlc3Q6ICdkYXRhJ30pXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgZXhwZWN0KHRydWUpLnRvLmVxdWFsKHRydWUpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICBleHBlY3QoZXJyKS50by5ub3QuZXhpc3Q7XG4gICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIGV4cGVjdChlcnIpLnRvLm5vdC5leGlzdDtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGV4cGVjdChlcnIpLnRvLm5vdC5leGlzdDtcbiAgICAgIH0pO1xuICAgIH0pXG4gICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICBleHBlY3QoZXJyKS50by5ub3QuZXhpc3Q7XG4gICAgICBkb25lKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgYmUgYWJsZSB0byByZWNlaXZlIGEgbWVzc2FnZSBhZnRlciBvbmUgb2YgdHdvIHN1YnNjcmliZXJzIHVuc3Vic2NyaWJlZCAoY29uY3VycmVudCknLCAoZG9uZSkgPT4ge1xuICAgIC8vIFN1YnNjcmliZSB0d29cbiAgICBQcm9taXNlLmFsbChbXG4gICAgICBwdWJzdWIuc3Vic2NyaWJlKCd0ZXN0ei50ZXN0JywgKCkgPT4ge1xuICAgICAgICBkb25lKG5ldyBFcnJvcignU2hvdWxkIG5vdCByZWFjaCcpKTtcbiAgICAgIH0pLFxuICAgICAgcHVic3ViLnN1YnNjcmliZSgndGVzdHoudGVzdCcsIChtZXNzYWdlKSA9PiB7XG4gICAgICAgIC8vIFJlY2VpdmUgbWVzc2FnZVxuICAgICAgICBleHBlY3QobWVzc2FnZSkudG8uZXhpc3Q7XG4gICAgICAgIGV4cGVjdChtZXNzYWdlLnRlc3QpLnRvLmVxdWFsKCdkYXRhJyk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0pXG4gICAgXSlcbiAgICAudGhlbigoW2lkMSwgaWQyXSkgPT4ge1xuICAgICAgZXhwZWN0KGlkMSkudG8uZXhpc3Q7XG4gICAgICBleHBlY3QoaWQyKS50by5leGlzdDtcbiAgICAgIGV4cGVjdChpZDEpLnRvLm5vdC5lcXVhbChpZDIpO1xuICAgICAgLy8gVW5zdWJzY3JpYmUgb25lXG4gICAgICBwdWJzdWIudW5zdWJzY3JpYmUoaWQxKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBwdWJzdWIucHVibGlzaCgndGVzdHoudGVzdCcsIHt0ZXN0OiAnZGF0YSd9KVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgZXhwZWN0KHRydWUpLnRvLmVxdWFsKHRydWUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBleHBlY3QoZXJyKS50by5ub3QuZXhpc3Q7XG4gICAgICAgICAgZG9uZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgZXhwZWN0KGVycikudG8ubm90LmV4aXN0O1xuICAgICAgfSk7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGV4cGVjdChlcnIpLnRvLm5vdC5leGlzdDtcbiAgICAgIGRvbmUoKTtcbiAgICB9KTtcbiAgfSk7XG5cbn0pO1xuIl19